
# SRE本メモ（3章 リスクの受容）
- 決して障害を起こさないなど、極端な信頼性はコストになり、サービス、ユーザにとってむしろマイナスになる。
  - 安定性を最大化することは、新機能開発の速度やユーザにプロダクトを届ける速度を制限し、コストを増大させる。
  - コストはチームが提供できる機能の数を減らす
- ユーザはサービスにおける高い信頼性と極端に高い信頼性との差異には気づかない
  - 99%の信頼性を持つスマートフォンを使っているユーザには、信頼性が99.9%の場合と99.999%の場合との違いはわからない
- SREは、単純に稼働時間を最大化するよりも、可用性におけるリスク・イノベーションの速度・サービス運用の効率性というゴールとのバランスを取ろうとする。

## 3.1 リスクの管理
- 信頼性とコストの関係は比例ではない。
  - 前回よりも100倍のコストがかかる場合もある。
- SREでは、サービスの信頼性を管理する大部分は、リスクを管理することによって行う。
  - システムの信頼性を高めるためのエンジニアリングと、サービスの適切な障害許容レベルを定めることは等しく重要。
  - サービスを十分信頼できるものにするために努力はするが、 **必要以上**に信頼性を高めようとはしない。
  - 可用性のターゲットは下限でもあり上限でもある。

## 3.2 サービスリスクの計測
- 多くのサービスにおいて、リスクの許容度を最も単純明快に表す方法は、 計画外の停止時間の許容レベルという観点から見てみること。
  - 計画外の停止時間はサービスの可用性に求められるレベルによって把握できる。
    - 可用性：システムが継続して稼働できる能力のこと。
    - 可用性は通常、"99.9%“、"99.99%"などのように表され、稼働時間の比率を基に計算されてきた。
  - 稼働時間を基にした可用性 → 「稼働時間 / (稼働時間 + 停止時間)」という式で表される。
- Googleは稼働時間を基にしたメトリクスではなく、リクエスト成功率という観点から可用性を定義している。
  - リクエスト成功率を基にした可用性 → 「成功したリクエスト数 / 総リクエスト数」
  - エンドユーザの観点から見て、全リクエスト数に対する成功したリクエスト数として計算された可用性は、予定外の停止時間の近似値として妥当なものだとGoogleは判断した。
- 同じ原則の多くは適用できる。
  - 例 :  データのバッチ処理の場合、処理に成功したレコード数と失敗したレコード数という観点でリクエスト成功率を使う。

## 3.3 サービスのリスク許容度
### 3.3.1 コンシューマサービスにおけるリスク許容度の明確化
- 可用性のターゲットレベル
  - ユーザの期待するサービスレベル
  - サービスが直接収入を生むか
  - サービスは有料か無料か
  - 強豪のサービスレベル
  - コシューマ向けか、企業向けか
- サービスで予想される障害の種類
  - 完全なサービス障害と部分的なサービス障害、どちらが悪いか。
- コスト
  - 可用性を1桁改善すると収入はどのように増えるか。
  - この追加収入はコストに見合うか。
- サービスの他のメトリクス
  - 例 : スピード

### 3.3.2 インフラストラクチャサービスのリスク許容度の明確化
- 可用性のターゲットレベル
- サービスで予想される障害の種類
- コスト

## 3.4 エラーバジェットの活用
- 異なるメトリクスの下で評価される開発チームとSREチーム
  - 開発チームのパフォーマンスは、主にプロダクト開発の速度で評価される。そのため、できる限り早く新しいコードを投入することにインセンティブが生じる
  - SREチームのパフォーマンスは、サービスの信頼性を基に評価される。
- 変更の頻度を高めることとは反対の方向にインセンティブが生じる

### 3.4.1 エラーバジェットの形成
- プロダクトマネージャーがSLO（サービスレベル目標）を規定。
  - これによりサービスの稼働時間を設定。
- 実際の稼働時間を計測。
- 上記2つの差異が「損失可能な信頼性」という予算。
- 計測された稼働時間がSLOを超えている（エラーバジェットがまだ残っている）のであれば新しいリリースをプッシュできる。

### 3.4.2 メリット
- プロダクト開発者とSREに共通のインセンティブを提供することで、両者がイノベーションと信頼性の適切なバランスを見出すことに注力できるようになる。
- プロダクト開発チームが自己統制するようになる。
  - エラーバジェットが余っているときは速度優先の開発をしたり、逆にエラーバジェットがほとんど余っていない時は自身でテストをもっとするなどしてリスクを下げようとする。
- 計測されているSLOがネットワークやデータセンターの障害によって減ってしまった場合はどうするか？
  - こうしたイベントもエラーバジェットを消費する。
  - SLOに対する責任は全員が共有するもの。

## 参考
- [Reading the SRE book](https://github.com/sysbooks/site-reliability-engineering)
- [『SRE サイトリライアビリティエンジニアリング』第3章読んだ](http://sandragon.hatenablog.com/entry/2017/09/10/212706)
